<!DOCTYPE html>
<html lang="zh-Hans" dir="ltr">
    <head>
        <meta charset="utf-8">
        <title>RpHMGDEF1 基本数据分析工具</title>
        <link rel="stylesheet" href="../css/bootstrap.css">
        <link rel="stylesheet" href="../css/app.css">
        <style media="screen">
        .mycard table * {
            border: none;
        }
        .mycard p, .mycard table * {
            font-family: 'Source Code Pro', 'Menlo', monospace, 'PingFang SC', 'Noto Sans CJK SC', 'Source Han Sans CN';
        }
        .mycard table td {
            background-clip: content-box !important;
            padding: 0px 0px 8px;
        }
        .mycard table td:first-child {
            width: 40%;
        }
        .mycard table .table-cell-real-content {
            border-radius: 3.5px;
            display: block !important;
            width: 100%;
            padding: 5px 8px;
        }
        </style>
        <script type="text/javascript">
        window.charts = {};
        charts.barsHorizontal = function (dataObj) {
            var dataObj_sample = [
                // ['key 1', 'value 1', width_percentage],
                ['key 1', 'value 1', 0.25],
                ['key 2', 'value 2', 0.5]
            ];
            // var dataObj = JSON.parse(JSON.stringify(dataObj_sample));
            var arr = dataObj.rows.map(function (row) {
                return `<tr>
                    <td>${row[0]}</td>
                    <td><span class="table-cell-real-content" style="background-image: linear-gradient(90deg, #F3F3F3 ${row[2]*100}%, #FFF ${row[2]*100}%);">${row[1]}</span></td>
                </tr>`;
            }).join('');
            return `<table class="table table-bordered1" style="">
                <tbody style="width: 100%;">
                ${arr}
                </tbody>
            </table>`;
        };
        </script>
        <script type="text/javascript">
        window.app = {};
        app.env = {
            lsk: 'd9a86f37c0554168a722caf7fbb4adcc_'
        };
        app.utils = {};
        app.utils.average = function (arr) {
            if (arr.length === 0) {
                return NaN;
            };
            return arr.reduce((x,y) => x+y)/arr.length;
        };
        app.utils.rightpad = function (str, len, pad) {
            return str + (new Array(len-str.length)).fill(pad).join('');
        };
        app.utils.leftpad = function (str, len, pad) {
            return (new Array(len-str.length)).fill(pad).join('') + str;
        };
        app.utils.addMissingDecimalDot = function (str) {
            if (str.indexOf('.') === -1) {
                return str + '.'
            } else {
                return str;
            };
        };
        app.dicts = {};
        app.dicts.dayNameToIndex = {
            'Sun': 0,
            'Mon': 1,
            'Tue': 2,
            'Wed': 3,
            'Thu': 4,
            'Fri': 5,
            'Sat': 6
        };
        app.dicts.timezones = {
            '00000': 'UTC',
            '+0800': 'Asia/Shanghai'
        };
        app.db = [];
        app.parseEntryInfo = function (entry) {
            var localDayInWeek = (new Date(entry.Time)).toLocaleString('en', { timeZone: app.dicts.timezones[entry.Timezone], weekday: 'short' });
            var localHour = (new Date(entry.Time)).toLocaleString('en', { timeZone: app.dicts.timezones[entry.Timezone], hourCycle: 'h24', hour: '2-digit'});
            var localMMDDYYYY = (new Date(entry.Time)).toLocaleString('en', { timeZone: app.dicts.timezones[entry.Timezone], hourCycle: 'h24', month: '2-digit', day: '2-digit', year: 'numeric'}).replace(/\s\-\//g, '/');
            var localYYYYMMDD = localMMDDYYYY.replace(/(\d{2})\/(\d{2})\/(\d{4})/g, '$3-$1-$2');
            var dateIdentifier = localYYYYMMDD + '|' + localDayInWeek;
            return {
                'localDayInWeek': localDayInWeek,
                'localHour': localHour,
                'localYYYYMMDD': localYYYYMMDD,
                'dateIdentifier': dateIdentifier,
                'Class': entry['Class'],
                'Class_Macro': entry['Class_Macro'],
                'Blur': entry['Blur']
            };
        };
        app.getDateIdentifierFromDateObj = function (dateObj) {
            return dateObj.toISOString().slice(0,10) + '|' + ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'][dateObj.getUTCDay()];
        };
        app.dataParser = function (rawDataStr) {
            var tmp = rawDataStr.trim().replace(/\n+/g, '\n').split('\n');
            var data = [];
            app.comments = [];
            tmp.map(function (rawRecord) {
                var record = rawRecord.split(';');
                if (record[0][0] === '#') {
                    app.comments.push(record.join(';'));
                    return false;
                };
                if (record.length < 4) {
                    return false;
                }
                if ((new Date(record[0])).toUTCString() === 'Invalid Date') {
                    return false;
                };
                if (!record[1].match(/^[A-HJ-NP-Z]{1,2}\d{0,2}$/)) {
                    return false;
                };
                if (!record[2].match(/^[-+0](0[0-9]|1[0-2])(00|30)$/)) {
                    return false;
                };
                if (!record[3].match(/^(accurate|blur)$/)) {
                    return false;
                };
                data.push({
                    'Time': record[0],
                    'Class': record[1],
                    'Class_Macro': record[1].replace(/\d/g, ''),
                    'Timezone': record[2],
                    'Blur': record[3]
                })
            });
            return {
                'realData': data,
                'comments': app.comments
            };
        };
        app.getCommonUsableData = function () {
            // Overall idea:
            // Find first date and last date; fill the gaps; generate a fill list of dates, as sorted.
            // Get counts for each date.
            // Get total dates of each weekday
            // End
            // ------------------------------------------
            // Step 1: Find first date and last date
            var explicitlyGivenDates = [];
            app.db.map(function (entry) {
                var parsedEntry = app.parseEntryInfo(entry);
                var dateIdentifier = app.parseEntryInfo(entry).dateIdentifier;
                explicitlyGivenDates.push(parsedEntry.dateIdentifier);
            });
            var firstGivenDateStr = explicitlyGivenDates.sort()[0];
            var lastGivenDateStr = explicitlyGivenDates.sort().reverse()[0];
            // console.log(explicitlyGivenDates);
            console.log('firstGivenDateStr', firstGivenDateStr);
            console.log('lastGivenDateStr', lastGivenDateStr);
            // Step 2: Fill the gaps to have a full list of dates
            var listOfDates = {};
            listOfDates[firstGivenDateStr] = 0;
            listOfDates[lastGivenDateStr] = 0;
            (function () {
                var initialDateStr = firstGivenDateStr.split('|')[0];
                var initialDateObj = new Date(initialDateStr + 'T00:00:05.000Z');
                var currentDateObj = new Date(initialDateStr + 'T00:00:05.000Z');
                var lastDateStr = lastGivenDateStr.split('|')[0];
                var lastDateObj = new Date(lastDateStr + 'T00:00:05.000Z');
                console.log('initialDateObj', initialDateObj);
                var getNextDay = function (dateObj) {
                    return new Date(dateObj.getTime()+24*3600*1000);
                };
                while (getNextDay(currentDateObj).getTime() <= lastDateObj.getTime()) {
                    listOfDates[app.getDateIdentifierFromDateObj(currentDateObj)] = 0;
                    currentDateObj = getNextDay(currentDateObj);
                };
                // console.log(listOfDates);
            })();
            // Step 3: Calculate counts of each date
            app.db.map(function (entry) {
                listOfDates[app.parseEntryInfo(entry).dateIdentifier] += 1;
            });
            // Step 4: Fill into each weekday
            var daysInWeek = [
                [],
                [],
                [],
                [],
                [],
                [],
                []
            ];
            console.log(listOfDates);
            Object.keys(listOfDates).sort().map(function (dateIdentifier) {
                var dayId = app.dicts.dayNameToIndex[dateIdentifier.split('|')[1]];
                daysInWeek[dayId] = daysInWeek[dayId].concat(listOfDates[dateIdentifier]);
            });
            console.log(daysInWeek);
            window.daysInWeek = daysInWeek;
            window.totalDatesInCalendar = daysInWeek.map(x => x.length).reduce((a,b) => a+b);
        };
        app.analyzers = [
            {
                'codeName': 'basicParsing',
                'name': '基本数据解析',
                'render': function (db, rawDataStr) {
                    return [
                        `读入注释 ${app.comments.length} 行`,
                        `读入数据 ${rawDataStr.trim().replace(/\n+/g, '\n').split('\n').length-app.comments.length} 行`,
                        `其中有效数据 ${db.length} 行`
                    ].map(function (x) {return `<p>${x}</p>`}).join('');
                }
            },
            {
                'codeName': 'basicAnalysis',
                'name': '基本概况',
                'render': function (db, rawDataStr) {
                    return `<p>时间跨度 ${totalDatesInCalendar} 天</p>
                    <p>共计 ${app.db.length} 次事件</p>
                    <p>平均每天 ${(app.db.length/totalDatesInCalendar).toString().slice(0,6)} 次</p>`;
                }
            },
            {
                'codeName': 'weeklyActivity',
                'name': '星期分布',
                'render': function (db) {
                    app.getCommonUsableData();
                    // Step 5: Generate result output
                    var maxDay = Math.max.apply(null, daysInWeek.map(function (x) {
                        return app.utils.average(x);
                    }));
                    console.log('maxDay', maxDay);
                    return charts.barsHorizontal({
                        'rows': daysInWeek.map(function (x, i) {
                            var normalizedNumber = app.utils.rightpad(app.utils.addMissingDecimalDot(app.utils.average(x).toString().slice(0,7)),7,'0');
                            var barLength = app.utils.average(x)/maxDay;
                            return [
                                '周' + '日一二三四五六'[i] + `（样本量：${x.length}）`,
                                (function (x) { return ( x.indexOf('NaN') === -1 ? x : '-' )})(normalizedNumber),
                                (isNaN(barLength) ? 0 : barLength)
                            ];
                        })
                    });
                }
            },
            {
                'codeName': 'hourlyDistribution',
                'name': '小时分布',
                'render': function (db) {
                    var hourGroups = (new Array(12)).fill(0);
                    var totalCounts = app.db.length;
                    app.db.map(function (x) {
                        if (app.parseEntryInfo(x).Blur !== 'accurate') {
                            return 0;
                        };
                        var currentHourGroup = Math.floor(parseInt(app.parseEntryInfo(x).localHour)/2);
                        hourGroups[currentHourGroup] = hourGroups[currentHourGroup] + 1;
                    });
                    console.log(hourGroups);
                    var maxHour = Math.max.apply(null, hourGroups.map(function (x) {
                        return x;
                    }));
                    return charts.barsHorizontal({
                        'rows': hourGroups.map(function (x, i) {
                            var barLength = x/maxHour;
                            return [
                                `${app.utils.leftpad((i*2).toString(),2,'0')}:00:00-${app.utils.leftpad((i*2+1).toString(),2,'0')}:59:59`,
                                (x/app.db.length*100).toString().slice(0,5) + '%',
                                (isNaN(barLength) ? 0 : barLength)
                            ];
                        })
                    });
                }
            },
            {
                'codeName': 'classComposition',
                'name': '类型构成',
                'render': function (db) {
                    var classOptions = [
                        [ 'A', '自慰射精' ],
                        [ 'B', '飞机杯' ],
                        [ 'C', '标准性生活射精（统称）' ],
                        [ 'C1', '标准性生活射精（标准）' ],
                        [ 'C2', '标准性生活射精（口射）' ],
                        [ 'C3', '标准性生活射精（撸射）' ],
                        [ 'C4', '标准性生活射精（顶射）' ],
                        [ 'C5', '标准性生活射精（手动前列腺按摩）' ],
                        [ 'C6', '标准性生活射精（双头龙）' ],
                        [ 'D', '未指定类型' ],
                        [ 'E', '参与 C 类型的性生活但没有射精（例：作为受，或仅为他人口交）' ],
                        [ 'F', '在 BDSM 活动中的射精（统称）' ],
                        [ 'F1', '在 BDSM 活动中的射精（有射精意愿的）' ],
                        [ 'F2', '在 BDSM 活动中的射精（无射精意愿的）' ],
                        [ 'G', '遗精（统称）' ],
                        [ 'G1', '梦遗' ],
                        [ 'G2', '清醒状态下的遗精' ],
                        [ 'H', '多人娱乐活动' ],
                        [ 'H1', '多人娱乐活动中的一次射精' ],
                        [ 'H2', '参与了一次多人娱乐活动，在过程未射精' ],
                        [ 'K', '意外射精（例：直肠指检）' ]
                    ];
                    var classData = {};
                    classOptions.map(x => {
                        classData[x[0]] = {
                            'code': x[0],
                            'description': x[1],
                            'count': 0
                        };
                    });
                    // console.log(classData);
                    app.db.map(entry => {
                        var parsedEntry = app.parseEntryInfo(entry);
                        classData[parsedEntry.Class].count = classData[parsedEntry.Class].count + 1;
                        if (parsedEntry.Class !== parsedEntry.Class_Macro) {
                            //  Also count for macro class
                            classData[parsedEntry.Class_Macro].count = classData[parsedEntry.Class_Macro].count + 1;
                        };
                    });
                    console.log('classData', classData);
                    var nonZeroClassData = [];
                    var maxCount = 0;
                    classOptions.map(x => {
                        if (classData[x[0]].count > 0) {
                            nonZeroClassData.push(JSON.parse(JSON.stringify(classData[x[0]])));
                        };
                        if (classData[x[0]].count > maxCount) {
                            maxCount = classData[x[0]].count;
                            console.log('maxCount', maxCount);
                        };
                    });
                    console.log('nonZeroClassData', nonZeroClassData);
                    // return '<p>本功能尚未实现</p>';
                    return charts.barsHorizontal({
                        'rows': nonZeroClassData.map(function (x, i) {
                            var barLength = x.count/maxCount;
                            return [
                                `${x.code}：${x.description}`,
                                (x.count/app.db.length*100).toString().slice(0,8) + '%',
                                (isNaN(barLength) ? 0 : barLength)
                            ];
                        })
                    });
                }
            },
            {
                'codeName': 'dailyAverageOverMonths',
                'name': '日均变化趋势',
                'render': function (db) {
                    return '<p>本功能尚未实现</p>';
                }
            }
        ];
        app.start = function () {
            localStorage[app.env.lsk+'rawDataInput'] = document.querySelector('#js-initialInputArea').value;
            app.db = app.dataParser(document.querySelector('#js-initialInputArea').value).realData;
            if (app.db.length > 0) {
                app.getCommonUsableData();
                app.analyzers.map(function (worker) {
                    document.querySelector(`[data-for-analyzer="${worker.codeName}"]`).innerHTML = worker.render(JSON.parse(JSON.stringify(app.db)), document.querySelector('#js-initialInputArea').value);
                });
            } else {
                document.querySelector(`[data-for-analyzer="basicParsing"]`).innerHTML = app.analyzers[0].render(JSON.parse(JSON.stringify(app.db)), document.querySelector('#js-initialInputArea').value);
            };
        };
        </script>
    </head>
    <body>
        <div class="world">
            <div class="cont">
                <div class="grand-header" style="padding: 60px 0 30px;">
                    <div class="block-constraint">
                        <div class="padless">
                            <h1>RpHMGDEF1 基本数据分析工具</h1>
                        </div>
                    </div>
                </div>

                <div class="grand-body">
                    <div class="block-constraint">
                        <div class="padless">
                            <h3 class="mb-4">输入原始数据</h3>
                            <div class="mb-4" id="">
                                <textarea id="js-initialInputArea" style="
                                    font-family: 'Source Code Pro', 'Menlo', monospace;
                                    font-size: 16px;
                                    background: #FFF;
                                    border: 1px solid #ced4da;
                                    border-radius: 3.5px;
                                    width: 100%;
                                    height: 4em;
                                    resize: none;
                                    padding: 6px 8px;
                                " placeholder="在此粘贴原始数据" autofocus></textarea>
                                <script type="text/javascript">
                                if (localStorage[app.env.lsk+'rawDataInput'] !== undefined) {
                                    document.querySelector('#js-initialInputArea').value = localStorage[app.env.lsk+'rawDataInput'];
                                };
                                </script>
                            </div>
                            <div class="form-group mb-3">
                                <button type="button" name="button" id="js-btnAnalyzeStart" class="btn btn-primary btn-lg btn-block" style="width: 60%; min-width: 200px; max-width: 300px; margin-left: auto; margin-right: auto;">分析数据</button>
                                <script type="text/javascript">
                                document.querySelector('#js-btnAnalyzeStart').addEventListener('click', function () {
                                    document.querySelectorAll(`[data-for-analyzer]`).forEach(function (x) {
                                        x.innerHTML = '';
                                    });
                                    setTimeout(app.start, 300);
                                });
                                window.addEventListener('load', function () { setTimeout(app.start, 350); });
                                </script>
                            </div>
                            <div class="form-group mb-5">
                                <button type="button" name="button" id="js-btnFillMockData" class="btn btn-link btn-block" style="width: 60%; min-width: 200px; max-width: 300px; margin-left: auto; margin-right: auto;">使用样例数据</button>
                                <script type="text/javascript">
                                var sampleMockData = [
                                    '# Sample Data',
                                    '# For sample purpose only',
                                    '2020-01-29T15:11:10.880Z;A;+0800;accurate',
                                    '2020-01-29T17:32:10.880Z;A;+0800;accurate',
                                    '2020-01-29T23:32:10.880Z;A;+0800;accurate',
                                    '2020-01-31T17:32:10.880Z;A;+0800;accurate',
                                    '2020-02-02T13:32:10.880Z;A;+0800;accurate',
                                    '2020-02-03T13:32:10.880Z;A;+0800;accurate',
                                    '2020-02-04T13:32:10.880Z;A;+0800;accurate',
                                    '2020-02-05T13:32:10.880Z;A;+0800;accurate',
                                    '2020-02-06T13:32:10.880Z;A;+0800;accurate',
                                    '2020-02-07T13:32:10.880Z;A;+0800;accurate',
                                    '2020-02-08T13:32:10.880Z;A;+0800;accurate',
                                    '2020-02-09T13:32:10.880Z;A;+0800;accurate',
                                    '2020-02-10T01:32:10.880Z;A;+0800;accurate',
                                    '2020-02-10T04:32:10.880Z;A;+0800;accurate',
                                    '2020-02-10T11:32:10.880Z;A;+0800;accurate',
                                    '2020-02-10T12:32:10.880Z;A;+0800;accurate',
                                    '2020-02-10T13:32:10.880Z;A;+0800;accurate'
                                ].join('\n');
                                document.querySelector('#js-btnFillMockData').addEventListener('click', function () {
                                    document.querySelectorAll(`[data-for-analyzer]`).forEach(function (x) {
                                        x.innerHTML = '';
                                    });
                                    document.querySelector('#js-initialInputArea').value = sampleMockData;
                                    setTimeout(app.start, 300);
                                });
                                </script>
                            </div>
                        </div>

                        <style media="screen">
                        .mycard {
                            box-shadow: rgba(0, 0, 0, 0.06) 0 3px 24px 1px;
                            border: 1px solid rgba(0, 0, 0, 0.04);
                            border-radius: 7px;
                            padding: 30px 20px;
                            margin: 0 0 30px;
                        }
                        .mycard h3 {
                            /* padding: 0px 0 0; */
                        }
                        </style>
                        <div id="js-listOfReportCards">
                        </div>
                        <script type="text/javascript">
                        document.querySelector('#js-listOfReportCards').innerHTML = app.analyzers.map(function (x) {
                            return `<div class="mycard">
                                <h3 class="mb-4">${x.name}</h3>
                                <div class="" data-for-analyzer="${x.codeName}">
                                </div>
                            </div>`;
                        }).join('');
                        </script>
                    </div>
                </div>

                <div class="grand-footer">
                    <div class="block-constraint">
                        <div class="padless">
                            <p>© 2020<script>
                            document.write(
                                ((new Date()).getFullYear() === 2020) ? '' : ('-' + (new Date()).getFullYear())
                            );
                            </script> Neruthes</p>
                            <p>本工具用于分析符合 <a href="https://github.com/neruthes/RpHMGDEF1">RpHMGDEF1</a> 格式的综合数据</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
